#############################################
# Builder Stage: Install dependencies and build
#############################################
FROM node:20-slim AS builder

# Enable corepack for pnpm support
RUN corepack enable

WORKDIR /app

# Install essential build tools
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

# Install all dependencies (including devDependencies for build)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build
# Force pnpm for UI build (Bun may fail on ARM/Synology architectures)
ENV OPENCLAW_PREFER_PNPM=1
RUN pnpm ui:build

# Remove node_modules and reinstall only production dependencies
# This ensures we don't carry dev dependencies or optional deps like canvas
RUN rm -rf node_modules

# Use pnpm fetch + install offline for cleaner production deps
RUN pnpm fetch --prod
RUN pnpm install --offline --prod --frozen-lockfile

# Optional: Remove @napi-rs/canvas if it was installed
RUN rm -rf node_modules/.pnpm/*canvas* 2>/dev/null || true

# Clean up pnpm store to save space
RUN rm -rf /root/.local/share/pnpm/store

# Show final node_modules size for debugging
RUN echo "=== Builder node_modules size ===" && \
    du -sh node_modules && \
    echo "=== Top 10 largest packages ===" && \
    (du -sh node_modules/.pnpm/* 2>/dev/null | sort -rh | head -10 || echo "N/A")

#############################################
# Runtime Stage: Minimal production image (SLIM - no canvas)
#############################################
FROM node:20-slim AS runtime

# Install only essential runtime dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

WORKDIR /app

ENV NODE_ENV=production

# Copy production dependencies from builder (without canvas)
COPY --from=builder /app/node_modules ./node_modules

# Copy only essential runtime files
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/openclaw.mjs ./openclaw.mjs
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/extensions ./extensions
COPY --from=builder /app/skills ./skills
COPY --from=builder /app/LICENSE ./LICENSE

# Show runtime node_modules size
RUN echo "=== Runtime node_modules size ===" && \
    du -sh node_modules

# Create necessary directories for runtime
RUN mkdir -p /home/node/.openclaw /home/node/.openclaw/workspace && \
    chown -R node:node /app /home/node/.openclaw

# Security hardening: Run as non-root user
USER node

# Start gateway server with default config
CMD ["node", "openclaw.mjs", "gateway", "--allow-unconfigured"]
