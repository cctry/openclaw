#############################################
# Builder Stage: Install dependencies and build
#############################################
FROM node:20-slim AS builder

# Enable corepack for pnpm support
RUN corepack enable

WORKDIR /app

# Install essential build tools
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

# Install all dependencies (including devDependencies for build)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build

# Remove node_modules and reinstall only production dependencies
# CRITICAL: --no-optional ensures @napi-rs/canvas is NEVER installed
RUN rm -rf node_modules

# Set environment variable to disable optional dependencies (defense in depth)
ENV PNPM_CONFIG_OPTIONAL=false

# Use pnpm fetch + install offline for cleaner production deps WITHOUT optional
RUN pnpm fetch --prod --no-optional
RUN pnpm install --offline --prod --no-optional --frozen-lockfile

# Assert: No canvas packages should exist
RUN echo "=== Verifying NO canvas packages in slim build ===" && \
    ! find node_modules -type d \( -name "*canvas*" -o -name "@napi-rs" \) 2>/dev/null | grep -q . && \
    echo "✓ Verified: No canvas packages found" || \
    (echo "✗ ERROR: Canvas packages found in slim build!" && exit 1)

# Clean up pnpm store to save space
RUN rm -rf /root/.local/share/pnpm/store

# Show final node_modules size for debugging
RUN echo "=== Builder node_modules size (SLIM - no optional) ===" && \
    du -sh node_modules && \
    echo "=== Top 10 largest packages ===" && \
    (du -sh node_modules/.pnpm/* 2>/dev/null | sort -rh | head -10 || echo "N/A")

#############################################
# Runtime Stage: Minimal production image (SLIM - no canvas)
#############################################
FROM node:20-slim AS runtime

# Install only essential runtime dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

WORKDIR /app

ENV NODE_ENV=production
# Ensure optional dependencies are never installed at runtime
ENV PNPM_CONFIG_OPTIONAL=false

# Copy production dependencies from builder (without canvas)
COPY --from=builder /app/node_modules ./node_modules

# Copy only essential runtime files
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/openclaw.mjs ./openclaw.mjs
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/extensions ./extensions
COPY --from=builder /app/skills ./skills
COPY --from=builder /app/LICENSE ./LICENSE

# Final verification: Assert no canvas in runtime
RUN echo "=== Runtime verification ===" && \
    ! find node_modules -type d \( -name "*canvas*" -o -name "@napi-rs" \) 2>/dev/null | grep -q . && \
    echo "✓ Runtime verified: No canvas packages" || \
    (echo "✗ ERROR: Canvas found in runtime!" && exit 1)

# Show runtime sizes
RUN echo "=== Runtime image sizes ===" && \
    du -sh node_modules && \
    du -sh dist && \
    du -sh extensions && \
    du -sh skills

# Create necessary directories for runtime
RUN mkdir -p /home/node/.openclaw /home/node/.openclaw/workspace && \
    chown -R node:node /app /home/node/.openclaw

# Security hardening: Run as non-root user
# The node:20-slim image includes a 'node' user (uid 1000)
# This reduces the attack surface by preventing container escape via root privileges
USER node

# Start gateway server with default config.
# Binds to loopback (127.0.0.1) by default for security.
#
# For container platforms requiring external health checks:
#   1. Set OPENCLAW_GATEWAY_TOKEN or OPENCLAW_GATEWAY_PASSWORD env var
#   2. Override CMD: ["node","openclaw.mjs","gateway","--allow-unconfigured","--bind","lan"]
CMD ["node", "openclaw.mjs", "gateway", "--allow-unconfigured"]
